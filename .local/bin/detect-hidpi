#!/bin/sh
# Auto-detect HiDPI and configure DPI settings
# Called during installation or manually to reconfigure DPI

# Get primary screen resolution
if command -v xrandr >/dev/null 2>&1 && [ -n "$DISPLAY" ]; then
    # X is running, use xrandr
    resolution=$(xrandr | grep '\*' | awk '{print $1}' | head -n1)
else
    # Fallback: try to read from kernel/system
    resolution=$(cat /sys/class/graphics/fb0/virtual_size 2>/dev/null | tr ',' 'x')
fi

# If still no resolution, use safe default
[ -z "$resolution" ] && resolution="1920x1080"

width=$(echo "$resolution" | cut -d'x' -f1)
height=$(echo "$resolution" | cut -d'x' -f2)

# Calculate DPI based on common screen sizes
# Assume typical laptop screen sizes
if [ "$width" -ge 3840 ]; then
    # 4K or higher
    dpi=192  # 2x scaling
    scale="2x"
elif [ "$width" -ge 2560 ]; then
    # 1440p or 1600p
    dpi=144  # 1.5x scaling
    scale="1.5x"
else
    # 1080p or lower
    dpi=96   # 1x scaling (standard)
    scale="1x"
fi

echo "Detected resolution: ${resolution}"
echo "Recommended DPI: ${dpi} (${scale} scaling)"

# Update Xresources if it exists
xresources="${XDG_CONFIG_HOME:-$HOME/.config}/x11/xresources"
if [ -f "$xresources" ]; then
    # Check if Xft.dpi line exists (commented or not)
    if grep -q "^!.*Xft.dpi:" "$xresources" || grep -q "^Xft.dpi:" "$xresources"; then
        # Uncomment and update existing line
        sed -i "s/^!.*Xft.dpi:.*/Xft.dpi: $dpi/" "$xresources"
        sed -i "s/^Xft.dpi:.*/Xft.dpi: $dpi/" "$xresources"
    else
        # Add new line after font rendering section
        sed -i "/^Xft.autohint:/i Xft.dpi: $dpi" "$xresources"
    fi
    
    # Update cursor size
    if [ "$dpi" -eq 192 ]; then
        cursor_size=48
    elif [ "$dpi" -eq 144 ]; then
        cursor_size=32
    else
        cursor_size=24
    fi
    sed -i "s/^Xcursor.size:.*/Xcursor.size: $cursor_size/" "$xresources"
    
    echo "✓ Updated $xresources"
    echo "  - Xft.dpi: $dpi"
    echo "  - Xcursor.size: $cursor_size"
fi

# Update xprofile with environment variables
xprofile="${XDG_CONFIG_HOME:-$HOME/.config}/x11/xprofile"
if [ -f "$xprofile" ]; then
    # Remove old scaling variables
    sed -i '/^export GDK_SCALE=/d' "$xprofile"
    sed -i '/^export GDK_DPI_SCALE=/d' "$xprofile"
    sed -i '/^export QT_AUTO_SCREEN_SCALE_FACTOR=/d' "$xprofile"
    sed -i '/^export QT_SCALE_FACTOR=/d' "$xprofile"
    
    # Add new scaling variables
    if [ "$dpi" -eq 192 ]; then
        cat >> "$xprofile" << 'EOF'

# HiDPI/4K scaling (auto-detected)
export GDK_SCALE=2
export GDK_DPI_SCALE=1
export QT_AUTO_SCREEN_SCALE_FACTOR=1
export QT_SCALE_FACTOR=2
EOF
    elif [ "$dpi" -eq 144 ]; then
        cat >> "$xprofile" << 'EOF'

# HiDPI scaling (auto-detected)
export GDK_SCALE=1.5
export GDK_DPI_SCALE=1
export QT_AUTO_SCREEN_SCALE_FACTOR=1
export QT_SCALE_FACTOR=1.5
EOF
    fi
    echo "✓ Updated $xprofile with scaling environment variables"
fi

# Reload Xresources if X is running
if [ -n "$DISPLAY" ] && command -v xrdb >/dev/null 2>&1; then
    xrdb "$xresources" 2>/dev/null && echo "✓ Reloaded Xresources"
fi

echo ""
echo "DPI configuration complete!"
echo "For changes to take full effect:"
echo "  1. Recompile suckless programs (st, dwm, dmenu) if needed"
echo "  2. Logout and login again (or reboot)"
echo ""
echo "To manually change DPI later:"
echo "  1. Edit: ~/.config/x11/xresources"
echo "  2. Set: Xft.dpi: <value>"
echo "  3. Run: xrdb ~/.config/x11/xresources"
echo "  4. Restart X"
